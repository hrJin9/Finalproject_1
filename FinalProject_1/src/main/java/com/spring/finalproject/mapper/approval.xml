<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="approval">
	
	<select id="getMyApprovalTotalCount" resultType="int" parameterType="HashMap">
		select count(*)
		from tbl_approval
		where fk_empno = #{employee_no} and status = 1
		<if test='searchStartday != "" and searchEndday != ""'>
			and to_char(writeday,'yyyy-mm-dd') between #{searchStartday} and #{searchEndday}
		</if> 
	</select>
	
	
	<select id="approvalListSearchWithPaging" resultType="com.spring.jieun.model.ApprovalVO" parameterType="HashMap">
		select rno, ano, fk_empno, ap_type, title, content, final_signyn, ap_systemFileName, writeday, modifyday
		     ,nvl(feedbackcnt,0) as feedbackcnt
		from
		(
		  select row_number() over (order by ano asc) as rno, ano, fk_empno
		       , ap_type, title, content, decode(final_signyn,0,'진행중',1,'승인',2,'반려') as final_signyn
		       , nvl2(ap_systemFileName,1,0) as ap_systemFileName
		       , to_char(writeday,'yyyy-mm-dd hh24:mi') as writeday, nvl(to_char(modifyday, 'yyyy-mm-dd hh24:mi'),0) as modifyday
		  from tbl_approval
		  where status = 1 and fk_empno = #{employee_no}
		  <if test='searchStartday != "" and searchEndday != ""'>
			and to_char(writeday,'yyyy-mm-dd') between #{searchStartday} and #{searchEndday}
		  </if>
		  order by rno desc
		) V 
		left join 
		(
		  select count(feedback) as feedbackcnt, fk_ano 
		  from tbl_approval_sign
		  group by fk_ano 
		)
		S
		on v.ano = s.fk_ano 
		where rno between #{startRno} and #{endRno}
	</select>
	

</mapper>