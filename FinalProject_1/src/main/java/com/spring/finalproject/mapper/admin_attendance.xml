<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="adAttendance">


	<select id="getAdTotal" parameterType="HashMap" resultType="int">
		select count(*)
		from
		(
		    select row_number() over(order by employee_no desc) as rno, employee_no, name_kr, fk_department_no, department_name, position, nvl(useCnt,0) as useCnt, dayoff_cnt
		    from
		    (
		        select fk_employee_no, sum(nvl(to_date(to_char(enddate, 'yyyy-mm-dd'), 'yyyy-mm-dd hh24:mi:ss') - to_date(to_char(startdate, 'yyyy-mm-dd'), 'yyyy-mm-dd hh24:mi:ss'),0)) as useCnt
		        from tbl_dayoff
		        group by fk_employee_no
		    )
		    right join v_employee
		    on fk_employee_no = employee_no
		    where employee_no != 99
		    <if test="searchVal != ''">
		    	and lower(name_kr) like '%'||lower(#{searchVal})||'%'
		    </if>
		    <if test="dropCondition != '' and dropVal != '' and dropVal != 'none'">
		    	and ${dropCondition} = #{dropVal}
		    </if>
		    <if test="dropCondition == 'department_name' and dropVal == 'none'"> 
		    	and department_name is null
		    </if>
		)
	</select>
	
	
	
	<select id="getAdList" parameterType="HashMap" resultType="com.spring.hyerin.model.EmployeeVO">
		select employee_no, name_kr, fk_department_no, department_name, position, useCnt, dayoff_cnt
		from
		(
		    select row_number() over(order by employee_no desc) as rno, employee_no, name_kr, fk_department_no, department_name, position, nvl(useCnt,0) as useCnt, dayoff_cnt
		    from
		    (
		        select fk_employee_no, sum(nvl(to_date(to_char(enddate, 'yyyy-mm-dd'), 'yyyy-mm-dd hh24:mi:ss') - to_date(to_char(startdate, 'yyyy-mm-dd'), 'yyyy-mm-dd hh24:mi:ss'),0)) as useCnt
		        from tbl_dayoff
		        group by fk_employee_no
		    )
		    right join v_employee
		    on fk_employee_no = employee_no
		    where employee_no != 99
		    <if test="searchVal != ''">
		    	and lower(name_kr) like '%'||lower(#{searchVal})||'%'
		    </if>
		    <if test="dropCondition != '' and dropVal != '' and dropVal != 'none'">
		    	and ${dropCondition} = #{dropVal}
		    </if>
		    <if test="dropCondition == 'department_name' and dropVal == 'none'"> 
		    	and department_name is null
		    </if>
		)
		where rno between #{startRno} and #{endRno}
	</select>
	
	
</mapper>
