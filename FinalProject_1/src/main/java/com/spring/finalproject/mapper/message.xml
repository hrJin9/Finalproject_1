<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="message">
	
	
	<!-- 한 사용자의 메시지목록 불러오기 -->
	<resultMap type="HashMap" id="getmvoList_Map">
		<result property="mno" column="mno" javaType="String"/>
		<result property="writer" column="writer" javaType="String"/>
		<result property="w_name" column="w_name" javaType="String"/>
		<result property="w_deptname" column="w_deptname" javaType="String"/>
		<result property="receiver" column="receiver" javaType="String"/>
		<result property="r_name" column="r_name" javaType="String"/>
		<result property="r_deptname" column="r_deptname" javaType="String"/>
		<result property="mgroup" column="mgroup" javaType="String"/>
		<result property="reno" column="reno" javaType="String"/>
		<result property="subject" column="subject" javaType="String"/>
		<result property="content" column="content" javaType="String"/>
		<result property="m_systemfilename" column="m_systemfilename" javaType="String"/>
		<result property="m_originfilename" column="m_originfilename" javaType="String"/>
		<result property="file_size" column="file_size" javaType="String"/>
		<result property="ms_sendtime" column="ms_sendtime" javaType="String"/>
		<result property="ms_checktime" column="ms_checktime" javaType="String"/>
	</resultMap>
	<select id="getmvoList" parameterType="HashMap" resultMap="getmvoList_Map">
		select mno, writer, w_name, w_deptname, receiver, name_kr as r_name, department_name as r_deptname, mgroup, reno, subject, content, m_systemfilename, m_originfilename, file_size, to_char(ms_sendtime,'yy. mm. dd') as ms_sendtime, to_char(ms_checktime,'yy. mm. dd') as ms_checktime, TMM.status
		from
		(
		    select rno, mno, writer, name_kr as w_name, department_name as w_deptname, receiver, mgroup, reno, subject, content, m_systemfilename, m_originfilename, file_size, ms_sendtime, ms_checktime, TM.status
		    from
		    (
		        select row_number() over(order by ms_sendtime desc) as rno, mno, writer, receiver, mgroup, reno, subject, content, m_systemfilename, m_originfilename, file_size, status, ms_sendtime, ms_checktime
		        from tbl_message M
		        join tbl_message_send MS
		        on M.mno = MS.fk_mno
		        <if test="tab == 'all'">
		        	where receiver = #{empno} and status = 1
		        </if>
		         <if test="tab == 'unread'">
			        where receiver = #{empno} and status = 1 and ms_checktime is null
		        </if>
		        <if test="tab == 'scrap'">
					join tbl_scrap S
					on S.tno = mno
					where receiver = #{empno} and status = 1
		        </if>
		    ) TM
		    left join v_employee E
		    on E.employee_no = writer
		    order by ms_sendtime desc
		) TMM
		left join v_employee
		on employee_no = receiver
		where rno between #{startRno} and #{endRno}
	</select>
	
	<!-- 메시지리스트의 총페이지수 알아오기 -->
	<select id="getmgtotal" parameterType="HashMap" resultType="int">
		select ceil(count(*)/#{sizePerPage})
		from
		(
		    select rno, mno, writer, name_kr as w_name, department_name as w_deptname, receiver, mgroup, reno, subject, content, m_systemfilename, m_originfilename, file_size, ms_sendtime, ms_checktime, TM.status
		    from
		    (
		        select row_number() over(order by ms_sendtime desc) as rno, mno, writer, receiver, mgroup, reno, subject, content, m_systemfilename, m_originfilename, file_size, status, ms_sendtime, ms_checktime
		        from tbl_message M
		        join tbl_message_send MS
		        on M.mno = MS.fk_mno
		        <if test="tab == 'all'">
		        	where receiver = #{empno} and status = 1
		        </if>
		         <if test="tab == 'unread'">
			        where receiver = #{empno} and status = 1 and ms_checktime is null
		        </if>
		        <if test="tab == 'scrap'">
					join tbl_scrap S
					on S.tno = mno
					where receiver = #{empno} and status = 1
		        </if>
		    ) TM
		    left join v_employee E
		    on E.employee_no = writer
		    order by ms_sendtime desc
		) TMM
		left join v_employee
		on employee_no = receiver
	</select>
	
	
	
	
	<!-- 로그인 유저가 클릭한 메시지내용 1개 불러오기 -->
	
	<!-- 메시지 내용 -->
	<select id="getmvo" parameterType="String" resultType="com.spring.hyerin.model.MessageVO">
		select mno, reno, writer, name_kr as w_name, department_name as w_dept, subject, content, m_systemfilename, m_originfilename, file_size, profile_orginfilename
		from tbl_message join v_employee on employee_no = writer
		where mno = #{mno}
	</select>
	
	<!-- 수신자정보 -->
	<select id="getmsvoList" parameterType="String" resultType="com.spring.hyerin.model.MessageSendVO">
		select fk_mno, receiver, name_kr as r_name, department_name as r_dept, profile_orginfilename, to_char(ms_sendtime, 'yyyy. mm. dd AM hh:mi') as ms_sendtime
		from tbl_message_send join v_employee on receiver = employee_no
		where fk_mno = #{mno}
	</select>
	
	
	<!-- 보낸시간 가져오기 -->
	<select id="getmstime" parameterType="String" resultType="String">
		select distinct to_char(ms_sendtime, 'yyyy. mm. dd AM hh:mi') as ms_sendtime
		from tbl_message_send
		where fk_mno = #{mno}
	</select>
	
	
	<!-- 메시지 파일 가져오기  -->
	<select id="getmfile" parameterType="String" resultType="com.spring.hyerin.model.MessageFileVO">
		
	
	</select>
	
	
	<!-- 부서정보 가져오기 -->
	<select id="getdept" resultType="com.spring.hyerin.model.DepartmentsVO">
		select department_no, department_name
		from tbl_departments
	</select>
	
	<!-- 부서, 팀 알아오기 -->
	<resultMap type="HashMap" id="getdt_Map">
		<result property="department_no" column="department_no" javaType="String"/>
		<result property="department_name" column="department_name" javaType="String"/>
		<result property="team_no" column="team_no" javaType="String"/>
		<result property="team_name" column="team_name" javaType="String"/>
		<result property="total" column="total" javaType="String"/>
	</resultMap>
	<select id="getdt" resultMap="getdt_Map">
		select department_no, department_name, team_no, team_name, total
		from
		(
		    select T.fk_department_no, TC.team_no, TC.team_name, TC.total
		    from
		    (
		        select team_no, team_name, count(employee_no) as total
		        from tbl_team
		        left outer join tbl_employee
		        on fk_team_no = team_no
		        where delete_status = 1
		        group by (team_no, team_name)
		    ) TC
		    join tbl_team T
		    on TC.team_no = T.team_no
		) T
		join tbl_departments D
		on D.department_no = T.fk_department_no
		where delete_status = 1
	</select>
	
	
	<!-- message_write -->
	
	<!-- 구성원목록 알아오기 -->
	<select id="getEmpList" parameterType="HashMap" resultType="com.spring.hyerin.model.EmployeeVO">
		select fk_department_no, department_name, fk_team_no, team_name, employee_no, name_kr, role, position, profile_systemfilename
		from v_employee
		where status = 1
		<choose>
			<when test="searchVal != ''">
				and #{searchCondition} like '%' || #{searchVal} || '%'
			</when>
			<otherwise>
				
			</otherwise>
		
		</choose>
		

	</select>
</mapper>