<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="attendance">

	<!-- 근무상태 저장하기  --> 
	<insert id="addAttendance" parameterType="HashMap">
		insert into tbl_attendance(adno, fk_employee_no, adcatgo, startdate, enddate)
		values('ad-'||seq_attendance_no.nextval, #{fk_employee_no}, #{adcatgo}, to_date(#{startdate}, 'yyyy-mm-dd hh24:mi'), to_date(#{enddate}, 'yyyy-mm-dd hh24:mi'))
	</insert>
	

	<!-- 휴가 개요 보여주기 -->
	<select id="dayoffListView" resultType="com.spring.yeeun.model.DayoffVO">
		<![CDATA[
		with 
		A as 
		(select dono, fk_employee_no, fk_ano, docatgo, 
		 to_char(startdate, 'yyyy.mm.dd') AS startdate, to_char(startdate, 'dy') AS startday,
		 to_char(enddate, 'yyyy.mm.dd') AS enddate, to_char(enddate, 'dy') AS endday
		 from tbl_dayoff
		),
		B as
		(select dono, startdate, enddate, round(cnt,0)as n, 
		        case when round(cnt,1)-trunc(cnt,0) > 0 and round(cnt,1)-trunc(cnt,0) < 0.3 then 0.5 
		             when round(cnt,1)-trunc(cnt,0) > 0.3 and round(cnt,1)-trunc(cnt,0) < 0.5 then 1
		             else 0 end as r 
		from 
		(select dono, to_char(startdate,'yyyy-mm-dd hh24:mi') as startdate, to_char(enddate,'yyyy-mm-dd hh24:mi') as enddate,
		       to_date(to_char(enddate,'yyyy-mm-dd hh24:mi') , 'yyyy-mm-dd hh24:mi') - to_date(to_char(startdate,'yyyy-mm-dd hh24:mi'),'yyyy-mm-dd hh24:mi') as cnt
		from tbl_dayoff) v)
		select A.dono, A.fk_employee_no, A.fk_ano, A.docatgo, A.startdate, A.startday, A.enddate, A.endday,
		       n+r as usedays
		FROM A JOIN B
		ON A.dono = B.dono
		where fk_employee_no = #{fk_employee_no} and substr(A.startdate, 0,4) = to_char(sysdate,'yyyy')  
		order by startdate desc
		]]>  <!-- 현재년도 기준  바뀜 -->
	</select>
	
	<select id="dayoffListViewByYear" parameterType="HashMap" resultType="com.spring.yeeun.model.DayoffVO">
		<![CDATA[
		with 
		A as 
		(select dono, fk_employee_no, fk_ano, docatgo, 
		 to_char(startdate, 'yyyy.mm.dd') AS startdate, to_char(startdate, 'dy') AS startday,
		 to_char(enddate, 'yyyy.mm.dd') AS enddate, to_char(enddate, 'dy') AS endday
		 from tbl_dayoff
		),
		B as
		(select dono, startdate, enddate, round(cnt,0)as n, 
		        case when round(cnt,1)-trunc(cnt,0) > 0 and round(cnt,1)-trunc(cnt,0) < 0.3 then 0.5 
		             when round(cnt,1)-trunc(cnt,0) > 0.3 and round(cnt,1)-trunc(cnt,0) < 0.5 then 1
		             else 0 end as r 
		from 
		(select dono, to_char(startdate,'yyyy-mm-dd hh24:mi') as startdate, to_char(enddate,'yyyy-mm-dd hh24:mi') as enddate,
		       to_date(to_char(enddate,'yyyy-mm-dd hh24:mi') , 'yyyy-mm-dd hh24:mi') - to_date(to_char(startdate,'yyyy-mm-dd hh24:mi'),'yyyy-mm-dd hh24:mi') as cnt
		from tbl_dayoff) v)
		select A.dono, A.fk_employee_no, A.fk_ano, A.docatgo, A.startdate, A.startday, A.enddate, A.endday,
		       n+r as usedays
		FROM A JOIN B
		ON A.dono = B.dono
		where fk_employee_no = #{fk_employee_no} and substr(A.startdate, 0,4) = #{year}
			  and to_date(A.startdate,'yyyy-mm-dd') <= to_date(to_char(sysdate, 'yyyy-mm-dd'), 'yyyy-mm-dd')
		order by startdate desc
		]]>
	</select>







</mapper>